<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8">
  <title>تفاصيل المنتج</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <div id="offlineNotice" style="padding:8px;background:#fff3cd;color:#856404;display:none;text-align:center">وضع عدم
    الاتصال: Supabase غير مهيأ — العمل في الوضع المحلي</div>

  <div class="container">
    <a href="index.html"
      style="color: var(--primary); font-weight: 700; text-decoration: none; display: inline-block; margin-bottom: 20px;">←
      العودة إلى المتجر</a>
    <section id="productDetail"
      style="background: #fff; padding: 40px; border-radius: 30px; box-shadow: var(--shadow); border: 1px solid rgba(212, 175, 55, 0.1);">
      <h2 id="p_title" style="color: var(--primary); font-size: 2rem; font-weight: 900; margin-bottom: 20px;">...</h2>
      <img id="p_image" src="" alt=""
        style="max-width:400px; width:100%; height:auto; border-radius:20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 30px;">
      <p id="p_price" style="color: var(--accent); font-size: 1.8rem; font-weight: 900; margin-bottom: 15px;">...</p>
      <p id="p_desc" style="color: var(--muted); font-size: 1.1rem; line-height: 1.8; margin-bottom: 30px;">وصف تجريبي—
        غريم توفر لك أرقى الهدايا والتوزيعات الدينية المصممة يدوياً وبكل حب لتناسب مناسباتكم السعيدة.</p>

      <!-- Quantity Control -->
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px;">
        <button id="minusBtn"
          style="width: 45px; height: 45px; border-radius: 12px; border: 2px solid var(--primary); background: #fff; color: var(--primary); cursor: pointer; font-size: 1.3rem; font-weight: 700; transition: all 0.3s ease;">
          <i class="fa-solid fa-minus"></i>
        </button>
        <input type="number" id="qtyInput" value="1" min="1"
          style="width: 80px; height: 45px; text-align: center; border-radius: 12px; border: 2px solid var(--border-color); font-weight: 700; font-size: 1.2rem; font-family: inherit; -moz-appearance: textfield; appearance: textfield;">
        <button id="plusBtn"
          style="width: 45px; height: 45px; border-radius: 12px; border: 2px solid var(--primary); background: #fff; color: var(--primary); cursor: pointer; font-size: 1.3rem; font-weight: 700; transition: all 0.3s ease;">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>

      <button id="buyBtn"
        style="background: var(--primary); color: #fff; padding: 15px 40px; border: 0; border-radius: 50px; font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(45, 90, 39, 0.2);">
        <i class="fa-solid fa-cart-plus"></i> إضافة للعلاگه
      </button>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const notice = document.getElementById('offlineNotice');
      if (!window.supabase) notice.style.display = 'block';
      loadProduct();
    });

    function qs(name) { const m = new URLSearchParams(location.search); return m.get(name); }
    async function loadProduct() {
      const id = qs('id');
      if (!id) return document.getElementById('p_title').textContent = 'خطأ: المعرف مفقود';

      // try supabase
      if (window.supabase) {
        try {
          const { data } = await supabase.from('stickers').select('*').eq('id', id).single();
          if (data) return render(data);
        } catch (e) { }
      }

      // fallback local
      const local = JSON.parse(localStorage.getItem('stickers_local') || '[]');
      const p = local.find(x => String(x.id) === String(id));
      if (p) render(p); else document.getElementById('p_title').textContent = 'المنتج غير موجود';
    }

    function render(p) {
      document.getElementById('p_title').textContent = p.title;
      document.getElementById('p_price').textContent = (p.price || 0).toLocaleString('ar-IQ') + ' د.ع';
      document.getElementById('p_image').src = p.image_url || p.thumb || 'https://via.placeholder.com/400x300?text=Gharim';

      // Update description from DB
      const descEl = document.getElementById('p_desc');
      if (p.description) {
        descEl.textContent = p.description;
      }

      // Check Inventory
      const quantity = p.quantity ?? 100; // Default 100 for old products
      const buyBtn = document.getElementById('buyBtn');

      if (quantity === 0) {
        buyBtn.innerHTML = '<i class="fa-solid fa-box"></i> نفذ المخزون';
        buyBtn.disabled = true;
        buyBtn.style.background = '#cccccc';
        buyBtn.style.cursor = 'not-allowed';
      }

      // Quantity Controls
      const qtyInput = document.getElementById('qtyInput');
      const plusBtn = document.getElementById('plusBtn');
      const minusBtn = document.getElementById('minusBtn');

      plusBtn.onclick = () => {
        qtyInput.value = parseInt(qtyInput.value) + 1;
      };

      minusBtn.onclick = () => {
        if (parseInt(qtyInput.value) > 1) {
          qtyInput.value = parseInt(qtyInput.value) - 1;
        }
      };

      // Add to Cart functionality
      buyBtn.onclick = () => {
        if (quantity === 0) return;

        const qty = parseInt(qtyInput.value) || 1;

        // Get existing cart
        const cart = JSON.parse(localStorage.getItem('cart_stickers') || '[]');

        // Check if product already exists in cart
        const existing = cart.find(x => x.id === p.id);
        if (existing) {
          existing.qty += qty;
        } else {
          cart.push({
            id: p.id,
            title: p.title,
            price: p.price,
            thumb: p.image_url || p.thumb,
            qty: qty
          });
        }

        // Save cart
        localStorage.setItem('cart_stickers', JSON.stringify(cart));

        // Show success message
        alert(`✅ تمت إضافة ${qty} من ${p.title} إلى العلاگه بنجاح!`);

        // Redirect to main page
        window.location.href = 'index.html';
      };
    }


  </script>
</body>

</html>